---
title: "FoodExpenditureAdmin3"
author: "MG"
date: "7/1/2022"
output: html_document
---

# Standard ggplot has distracting features - adjust those
```{r}
remove_chart_clutter <- 
  theme(    
    panel.grid.major = element_blank(),      # Remove panel grid lines
    panel.grid.minor = element_blank(),      # Remove panel grid lines
    panel.background = element_blank(),      # Remove panel background
    axis.line = element_line(colour = "grey"),       # Add axis line
    axis.title.y = element_text(angle = 0, vjust = 0.5),      # Rotate y axis so don't have to crank head
    legend.position="bottom"
  ) 
```


# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# 0. Load Libraries and Options -----
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# On first run will need to uncomment and run if packages are not installed 
# install.packages("tidyverse")
# install.packages("janitor")
# install.packages("sf")
# install.packages("viridis")
# install.packages("ggthemes")
# install.packages("tidylog")
```{r}
library(tidyverse)
library(janitor)
library(sf)
library(viridis)
library(tidylog)
```
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# 1. Load Merged Data for Analysis (from Prior Scripts) ------ 
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
```{r}
LSMSdata <- read.csv("C:/Users/Milind Gupta/Desktop/2022_DSPG_SAHEL/2022_DSPG_Sahel/nigerlsms_11_14_18_slim.csv")
niger_level3 <- st_read(
   "C:/Users/Milind Gupta/Desktop/dspg-sahel/Level 3_new/NER_adm03_feb2018.shp")
```
# Don't show scientific notation
```{r}
options(scipen = 999)
```
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# 2. Convert LSMS data to spatial dataset, generate median over admin unit ------ 
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# A. Convert LSMS into Spatial Dataset for simple features ---- 
```{r}
lsms_sf <- st_as_sf(LSMSdata, 
                    coords=c("longitude","latitude"), 
                    crs="WGS84", #"EPSG:2931",
                    na.fail=FALSE)
```
# B. Join the spatial data and welfare information (what departments are each observation in?)
# If we use left=TRUE here, our result will retain all the points in the dataset rather 
# than just the the spatial overlaps (where points fall inside polygons).
```{r}
lsms_admin3 <- 
  st_join(niger_level3, lsms_sf, left = TRUE) 
  
```
# C. Generate median values by geometry ---- 
# these lines may take a couple of minutes to run 
```{r}
start_time <- Sys.time()
lsms_median <-
  lsms_admin3 %>%
  # clusters refer to one consistent enumeration area
  # there many be many enumeration areas per administrative region, so use the admin region instead
  group_by(adm_03, year) %>%
  # this should be no more than 266 observations per year, as we're working at admin3 (it's 160  per year)
  mutate(median_foodexpend = median(pcexp_food),
         median_totalexpend = median(pcexp),
         median_nonfoodexp = median(pcexp_nonfood)
       ) %>%
  ungroup() %>% 
  distinct(adm_03, year, median_foodexpend, 
           median_totalexpend, median_nonfoodexp, 
           geometry)


# Develop check on number of units

nrow(lsms_median) < 266*3




end_time <- Sys.time()
end_time - start_time
```   
# Time difference of 

# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# 3. Generate Maps ------ 
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

# A. Median Annual PC Food Expenditure ---- 
```{r}

niger_level3 %>%
  ggplot() +
  geom_sf(color = "NA") +
  geom_sf(data = na.omit(lsms_median), #na.omit gets rid of the NA facet
          size = 1, 
          color = "NA",
          aes(fill = median_foodexpend/100000), alpha = 1) + #alpha indicates transparency
  facet_wrap(~year, nrow = 1) +
  labs(title = "Median Annual Per Capita Food Expenditure by Commune (Admin 3)", 
       subtitle = "Units in 100,000 West African Francs, with 400-600 Francs to 1 USD",
       caption = paste0("Gray indicates no observations\n",
                        "Data Source: LSMS")) + 
  coord_sf() +
  scale_fill_viridis(name = "Annual Median West African CFA Francs (100k)") +
  theme_classic() +
  theme(legend.position="bottom")
```

# B. Median Annual PC Nonfood Expenditure ---- 
```{r}

niger_level3 %>%
  ggplot() +
  geom_sf(color = "NA") +
  geom_sf(data = na.omit(lsms_median), #na.omit gets rid of the NA facet
          size = 1, 
          color = "NA",
          aes(fill = median_nonfoodexp/100000), alpha = 1) + #alpha indicates transparency
  facet_wrap(~year, nrow = 1) +
  labs(title = "Median Annual Per Capita Nonfood Expenditure by Commune (Admin 3)", 
       subtitle = "Units in 100,000 West African Francs, with 400-600 Francs to 1 USD",
       caption = paste0("Gray indicates no observations\n",
                        "Data Source: LSMS")) + 
  coord_sf() +
  scale_fill_viridis(name = "Annual Median West African CFA Francs (100k)") +
  theme_classic() +
  theme(legend.position="bottom")
```

# C. Share of Food Expenditure Relative to the Whole ---- 
# TODO: verify this mathematically is correct 
# (may need to reconsider first doing household level shares then taking the median of those)
```{r}
niger_level3 %>%
  ggplot() +
  geom_sf(color = "NA") +
  geom_sf(data = na.omit(lsms_median), #na.omit gets rid of the NA facet
          size = 1, 
          color = "NA",
          aes(fill = median_foodexpend/(median_nonfoodexp+median_foodexpend)*100), 
              alpha = 1) + #alpha indicates transparency
  facet_wrap(~year, nrow = 1) +
  labs(title = "Share of Food Expenditure Relative to Total Expenditure by Commune (Admin 3)", 
       subtitle = "",
       caption = paste0("Gray indicates no observations\n",
                        "Data Source: LSMS")) + 
  coord_sf() +
  scale_fill_viridis(name = "Share Per Capita Food Expenditure") +
  theme_classic() +
  theme(legend.position="bottom")
```
## TODO: Double Check aggregation and why some values are so extreme --- 

# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# 3. For Discussion -- Why Some Values are Extreme, and Where Aggregation Happened
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

# Indicate the distribution of values over time
```{r}

LSMSdata %>% 
  ggplot(aes(x = pcexp_food/pcexp)) +
  geom_histogram() +
  facet_wrap(~year) +
  labs(title = "Food Expenditure Relative to Total Expenditure by Observation") +
  remove_chart_clutter +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0))
```

# first aggregate by household and survey waves to ensure have totals
```{r}

LSMSdata <- 
  LSMSdata %>% 
  group_by(hhid, year) %>% 
  mutate(total_pc_exp = sum(pcexp, na.rm = TRUE), 
         food_pc_exp = sum(pcexp_food, na.rm = TRUE),
         nonfood_pc_exp = sum(pcexp_nonfood, na.rm = TRUE)) %>% 
  ungroup()

LSMSdata %>% 
  ggplot(aes(x = food_pc_exp/total_pc_exp)) +
  geom_histogram() +
  facet_wrap(~year) +
  labs(title = "Food Expenditure Relative to Total Expenditure by HHID") +
  remove_chart_clutter +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0))

```
# set to origin

