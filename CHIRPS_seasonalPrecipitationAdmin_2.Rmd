---
title: "CHIRPS_seasonalPrecipitation"
author: "CHB"
date: '2022-06-23'
output: html_document
---

Packages
```{r}
library(dplyr)
library(moderndive)
library(readr)
library(tidyr)
library(tidyverse)
library(lubridate)
library(reshape2)
library(ggplot2)
library(sf)
library(sp)
library(rgdal)
```

Read in Data
```{r}
csvData_admin2 <-read.csv("C:/Users/Catherine/OneDrive/Documents/2022_DSPG_Sahel/rainfallMean_ts_niger_adm2.csv")

csvData_admin3 <-read.csv("C:/Users/Catherine/OneDrive/Documents/2022_DSPG_Sahel/rainfallMean_ts_niger_adm3.csv")
```

Renaming the Columns
```{r}
for ( col in 1:ncol(csvData_admin2)){
  colnames(csvData_admin2)[col] <- sub("_precipitation", "", colnames(csvData_admin2)[col])
}
for ( col in 1:ncol(csvData_admin2)){
  colnames(csvData_admin2)[col] <- sub("X", "", colnames(csvData_admin2)[col])
}


for ( col in 1:ncol(csvData_admin3)){
  colnames(csvData_admin3)[col] <- sub("_precipitation", "", colnames(csvData_admin3)[col])
}
for ( col in 1:ncol(csvData_admin3)){
  colnames(csvData_admin3)[col] <- sub("X", "", colnames(csvData_admin3)[col])
}
```

Convert data from Wide to Long for years 1981 to 1994
```{r}
precipitationData2 <- csvData_admin2 %>%
  select(admin2Name,admin2Pcod, "19810101": "20220121")
precipitationDataLong2 <- gather(precipitationData2, Date, Precipitation, "19810101":"20220121")

precipitationData3 <- csvData_admin3 %>%
  select(adm_03, rowcacode3, "19810101": "20220121")
precipitationDataLong3 <- gather(precipitationData3, Date, Precipitation, "19810101":"20220121")
```

Convert Characters to Dates, then create columns 
```{r}
precipitationDataLong2$Date <- ymd(precipitationDataLong2$Date)

precipitationDataLong3$Date <- ymd(precipitationDataLong3$Date)


data_admin2 <- precipitationDataLong2 %>%
  dplyr::mutate(year = lubridate::year(precipitationDataLong2$Date), 
                month = lubridate::month(precipitationDataLong2$Date), 
                day = lubridate::day(precipitationDataLong2$Date)) %>%
  ungroup()

data_admin3 <- precipitationDataLong3 %>%
  dplyr::mutate(year = lubridate::year(precipitationDataLong3$Date), 
                month = lubridate::month(precipitationDataLong3$Date), 
                day = lubridate::day(precipitationDataLong3$Date)) %>%
  ungroup()
```

All Years
```{r}
yearData_admin2 <- data_admin2 %>% 
  group_by(admin2Name,admin2Pcod, year) %>%
  filter(year >= "1981" & year <= "2021") %>%
  mutate(total_precipitation = sum(Precipitation, na.rm = TRUE),
         mean_precipitation = mean(Precipitation, na.rm = TRUE),
         standardDeviation_precipitation = sd(Precipitation, na.rm = TRUE)) %>%
  distinct(total_precipitation, .keep_all = TRUE) %>%
  ungroup()

yearData_admin3 <- data_admin3 %>% 
  group_by(adm_03, rowcacode3, year) %>%
  filter(year >= "1981" & year <= "2021") %>%
  mutate(total_precipitation = sum(Precipitation, na.rm = TRUE),
            mean_precipitation = mean(Precipitation, na.rm = TRUE),
            standardDeviation_precipitation = sd(Precipitation, na.rm = TRUE)) %>%
  distinct(total_precipitation, .keep_all = TRUE) %>%
  ungroup()
```
         
All Years 3 Regions
```{r}

#Desert = (yearData_admin2$admin1Name == "Agadez"|yearData_admin2$admin1Name == "Diffa"|yearData_admin2$admin1Name == "Zinder")

#agroPastoral = (yearData_admin2$admin1Name == "Tahoua"|yearData_admin2$admin1Name == "Maradi")

#rainfed = (yearData_admin2$admin1Name == "Tillabery" | yearData_admin2$admin1Name == "Dosso"|| yearData_admin2$admin1Name == "Niamey")
```

Filtered 1981 to 2010 Baseline Data
```{r}
baselineData_admin2 <- yearData_admin2 %>% 
  group_by(admin2Name, admin2Pcod) %>%
  filter(year >= "1981" & year <= "2010") %>% 
  mutate(baselineTotal_precipitation = sum(total_precipitation, na.rm = TRUE),
            baselineMean_precipitation = mean(total_precipitation, na.rm = TRUE),
            baselineSD_precipitation = sd(total_precipitation, na.rm = TRUE)) %>%
  ungroup()

baselineData_admin3 <- yearData_admin3 %>% 
  group_by(adm_03, rowcacode3) %>%
  filter(year >= "1981" & year <= "2010") %>% 
  mutate(baselineTotal_precipitation = sum(total_precipitation, na.rm = TRUE),
            baselineMean_precipitation = mean(total_precipitation, na.rm = TRUE),
            baselineSD_precipitation = sd(total_precipitation, na.rm = TRUE)) %>%
  ungroup()
```

2011 to 2020 Filtered with baseline z-score
```{r}
periodData_admin2 <- yearData_admin2 %>% 
  group_by(admin2Name,admin2Pcod, year) %>%
  filter(year >= "2011" & year <= "2021") %>% 
  ungroup()

datajoin_admin2 = merge(x = baselineData_admin2, y = periodData_admin2, by = "admin2Pcod") %>%
  mutate(zscore_precipitation = ((total_precipitation - baselineMean_precipitation)/(baselineSD_precipitation)))


periodData_admin3 <- yearData_admin3 %>% 
  group_by(adm_03,rowcacode3, year) %>%
  filter(year >= "2011" & year <= "2021") %>% 
  ungroup()

datajoin_admin3 = merge(x = baselineData_admin3, y = periodData_admin3, by = "rowcacode3") %>%
  mutate(zscore_precipitation = ((total_precipitation - baselineMean_precipitation)/(baselineSD_precipitation)))
```

Seasonal Precipitation Summary
```{r}
#Seasonal Data
seasonalData_admin2 <- data_admin2 %>% 
  group_by(admin2Name,admin2Pcod, year, month) %>%
  filter(month >= 6 & month <= 9) %>% 
  summarise(seasonalTotal_precip = sum(Precipitation, na.rm = TRUE),
            seasonalMean_precip = mean(Precipitation, na.rm = TRUE)) %>%
  ungroup()


seasonalData_admin3 <- data_admin3 %>% 
  group_by(adm_03,rowcacode3, year, month) %>%
  filter(month >= 6 & month <= 9) %>% 
  summarise(seasonalTotal_precip = sum(Precipitation, na.rm = TRUE),
            seasonalMean_precip = mean(Precipitation, na.rm = TRUE)) %>%
  ungroup()

#Baseline Seasonal Data
baselineSeasonalData_admin2 <- seasonalData_admin2 %>% 
  group_by(admin2Name, admin2Pcod, year, month) %>%
  filter(year >= "1981" & year <= "2010") %>% 
  summarise(baselineTotal_precipitation = sum(seasonalTotal_precip, na.rm = TRUE),
            baselineMean_precipitation = mean(seasonalTotal_precip, na.rm = TRUE),
            baselineSD_precipitation = sd(seasonalTotal_precip, na.rm = TRUE)) %>%
  ungroup()

baselineSeasonalData_admin3 <- seasonalData_admin3 %>% 
  group_by(adm_03, rowcacode3, year, month) %>%
  filter(year >= "1981" & year <= "2010") %>% 
  summarise(baselineTotal_precipitation = sum(seasonalTotal_precip, na.rm = TRUE),
            baselineMean_precipitation = mean(seasonalTotal_precip, na.rm = TRUE),
            baselineSD_precipitation = sd(seasonalTotal_precip, na.rm = TRUE)) %>%
  ungroup()


#Combine Baseline data with current year data
seasonalCurrentData_admin2 <- seasonalData_admin2 %>% 
  group_by(admin2Name,admin2Pcod, year, month) %>%
  filter(year >= "2011" & year <= "2021") %>% 
  ungroup()

seasonalDataCombined_admin2 = merge(x = baselineSeasonalData_admin2, y = seasonalCurrentData_admin2, by = "admin2Pcod") %>%
  mutate(zscore_precipitation = ((seasonalTotal_precip - baselineMean_precipitation)/(baselineSD_precipitation)))


seasonalCurrentData_admin3 <- seasonalData_admin3 %>% 
  group_by(adm_03,rowcacode3, year, month) %>%
  filter(year >= "2011" & year <= "2021") %>% 
  ungroup()

seasonalDataCombined_admin3 = merge(x = baselineSeasonalData_admin3, y = seasonalCurrentData_admin3, by = "rowcacode3") %>%
  mutate(zscore_precipitation = ((seasonalTotal_precip - baselineMean_precipitation)/(baselineSD_precipitation)))

```



#Visuals


#Bring in Shape Files
```{r}
nigerMapAdmin2 <- st_read("C:/Users/Catherine/OneDrive/Documents/2022_DSPG_Sahel/niger_admin2/niger_admin2.shp")

nigerMapAdmin3 <- st_read("C:/Users/Catherine/OneDrive/Documents/2022_DSPG_Sahel/niger_admin3/NER_adm03_feb2018.shp")
```

Merge Data with Shape Files
```{r}
nigerShpMerged_admin2 = full_join(nigerMapAdmin2, datajoin_admin2 ,by="admin2Pcod")

nigerShpMerged_admin3 = full_join(nigerMapAdmin3, datajoin_admin3 ,by="rowcacode3")
```

Total Precipitation Admin 2 and Admin 3 Maps + Bar Graph
```{r}
ggplot(nigerShpMerged_admin2) + theme_classic() + theme(axis.text.x = element_blank(),axis.text.y = element_blank(),axis.ticks = element_blank(),rect = element_blank()) +
  geom_sf(aes(fill = total_precipitation), color = NA, alpha = 0.8) +
  scale_fill_viridis_c( direction = -1) +
  labs(title="Annual Cumulative Rainfall by Department (Admin 2)", caption = "Data Source: CHIRPS Pentad Precipitation dataset", fill = "Precipitation (mm)" ) +
  facet_wrap(~year)

ggplot(nigerShpMerged_admin3) + theme_classic() + theme(axis.text.x = element_blank(),axis.text.y = element_blank(),axis.ticks = element_blank(),rect = element_blank()) +
  geom_sf(aes(fill = total_precipitation),color = NA, alpha = 0.8) +
  scale_fill_viridis_c( direction = -1) +
  labs(title="Annual Cumulative Rainfall by Commune (Admin 3)", caption = "Data Source: CHIRPS Pentad Precipitation dataset", fill = "Precipitation (mm)" ) +
  facet_wrap(~year)
 
```


z-score Precipitation Admin 2 and Admin 3
```{r}
#Admin 2 Slide 10
nigerShpMerged_admin2 %>% 
  filter(year == 2011 | year == 2014 | year == 2015| year == 2017 | year == 2018) %>%
  ggplot() + theme_classic() + theme(axis.text.x = element_blank(),axis.text.y = element_blank(),axis.ticks = element_blank(),rect = element_blank()) +
  geom_sf(aes(fill = zscore_precipitation),color = NA, alpha = 0.8) +
  scale_fill_viridis_c(direction = -1) +
  facet_wrap(~year, nrow = 1) +
  labs(title="Annual Z-Score Rainfall by Department (Admin 2)", fill = "z-score" )

#Admin 3 Slide 10
nigerShpMerged_admin3 %>% 
  filter(year == 2011 | year == 2014 | year == 2015| year == 2017 | year == 2018) %>%
  ggplot() + theme_classic() + theme(axis.text.x = element_blank(),axis.text.y = element_blank(),axis.ticks = element_blank(),rect = element_blank()) +
  geom_sf(aes(fill = zscore_precipitation),color = NA, alpha = 0.8) +
  scale_fill_viridis_c(direction = -1) +
  facet_wrap(~year, nrow = 1) +
  labs(title="Annual Z-Score Rainfall by Commune (Admin 3)", fill = "z-score" )
```


```{r}
annualPrecip <- yearData_admin2 %>%
  group_by(year) %>%
  mutate(meanAnnualPrecip = mean(total_precipitation)) %>%
  ungroup() %>%
  distinct(year, meanAnnualPrecip)

#Region Data Slide 7
ggplot(annualPrecip, aes(x=year, y=meanAnnualPrecip, na.rm=TRUE)) +
  geom_line() + theme_classic() +
  labs(title="Average Rainfall by Year", x="Year", y="Average Precipitation (mm)")
```
